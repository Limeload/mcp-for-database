name: Update Contributors

on:
  pull_request:
    types: [closed]

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Check contributor status and update
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = require('@actions/github');
            const { owner, repo } = context.repo;
            const prAuthor = context.payload.pull_request.user.login;
            
            console.log(`Checking contributor status for ${prAuthor}`);
            
            // Get all merged PRs by this author
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });
            
            const mergedPRs = prs.filter(pr => 
              pr.merged_at && pr.user.login === prAuthor
            );
            
            console.log(`Found ${mergedPRs.length} merged PRs by ${prAuthor}`);
            
            // Check if they have 15 or more merged PRs
            const isContributor = mergedPRs.length >= 15;
            
            if (!isContributor) {
              console.log(`${prAuthor} has ${mergedPRs.length} PRs, needs 15 to be a contributor`);
              return;
            }
            
            console.log(`${prAuthor} is now a contributor with ${mergedPRs.length} PRs!`);
            
            // Read current CONTRIBUTORS.md
            const fs = require('fs');
            const path = require('path');
            const contributorsFile = path.join(process.cwd(), 'CONTRIBUTORS.md');
            
            if (!fs.existsSync(contributorsFile)) {
              console.log('CONTRIBUTORS.md not found, skipping update');
              return;
            }
            
            let content = fs.readFileSync(contributorsFile, 'utf8');
            
            // Check if author is already in the contributors list
            if (content.includes(`- **${prAuthor}**`)) {
              console.log(`${prAuthor} is already in the contributors list`);
              return;
            }
            
            // Add new contributor
            const contributorEntry = `- **${prAuthor}** - ${mergedPRs.length} merged PRs\n`;
            
            // Find the contributors section and add the new contributor
            const contributorsSection = content.match(/## üèÜ Contributors\n([\s\S]*?)(?=\n### |\n## |$)/);
            if (contributorsSection) {
              const newContributorsSection = contributorsSection[0] + contributorEntry;
              content = content.replace(contributorsSection[0], newContributorsSection);
            }
            
            // Update statistics
            const currentStats = content.match(/## üéØ Current Statistics\n([\s\S]*?)(?=\n---)/);
            if (currentStats) {
              const statsMatch = currentStats[1].match(/- \*\*Total Contributors\*\*: (\d+)/);
              if (statsMatch) {
                const currentCount = parseInt(statsMatch[1]);
                const newCount = currentCount + 1;
                content = content.replace(
                  /- \*\*Total Contributors\*\*: \d+/,
                  `- **Total Contributors**: ${newCount}`
                );
              }
            }
            
            // Write updated content
            fs.writeFileSync(contributorsFile, content);
            
            console.log(`Added ${prAuthor} to contributors list with ${mergedPRs.length} PRs`);
            
            // Commit and push changes
            const { execSync } = require('child_process');
            execSync('git config --local user.email "action@github.com"');
            execSync('git config --local user.name "GitHub Action"');
            execSync('git add CONTRIBUTORS.md');
            execSync(`git commit -m "docs: add ${prAuthor} to contributors list"`);
            execSync('git push');
            
            // Create a congratulatory issue
            await github.rest.issues.create({
              owner,
              repo,
              title: `üéâ Congratulations ${prAuthor}! You're now a project contributor!`,
              body: `## üèÜ Contributor Recognition\n\nCongratulations @${prAuthor}! You've successfully made **${mergedPRs.length} approved pull requests** and are now recognized as a project contributor!\n\n### What this means:\n- ‚úÖ You're now listed in our [CONTRIBUTORS.md](CONTRIBUTORS.md) file\n- ‚úÖ You're eligible for Hacktoberfest completion\n- ‚úÖ You're recognized as a valued community member\n- ‚úÖ You can help review other contributors' PRs\n\n### Thank you for your contributions! üöÄ\n\nKeep up the great work and continue contributing to make this project even better!\n\n---\n*This issue was automatically created to recognize your achievement.*`,
              labels: ['hacktoberfest', 'contributor-recognition']
            });
            
            console.log(`Created recognition issue for ${prAuthor}`);
